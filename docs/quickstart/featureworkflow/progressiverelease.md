
案例文档正在完善中，敬请期待...

希望提前体验的小伙伴，可以联系我们。我们将会调整开关分流，将部分功能对您提前开放。

<!-- 
# 如何在影响所有用户之前，渐进逐步的部署新的功能特性

在当今这个快节奏、功能驱动的市场中，持续提供价值并快速、持续地接收功能反馈非常重要。与终端用户合作，让早期版本的功能得到审核是很有价值的。

您是否计划将自己的软件扩展功能并部署到线上生产环境中？你可能会有一些问题，比如:

- 如何拥抱DevOps以更快地交付变更和价值？
- 你如何降低部署到线上的风险？
- 你如何实现部署的自动化？

本主题旨在回答这些问题，并分享使用feature-flags.co实现"环式"部署的学习成果。



## 一个或多个"环"来规范你的部署

部署环最早是在Jez Humble的书中讨论的。它们支持生产优先的DevOps思想，并限制对终端用户的影响，同时在生产中逐步部署和验证变化。影响（也称为爆炸半径），通过观察、测试、分析遥测和用户反馈来评估。

## 考虑因素

在你将你的部署基础架构转换为环形部署模式之前，需要考虑如下问题:

- 谁是你的主要用户类型？例如，早期采用者和用户。
- 你的应用拓扑结构是什么？
- 拥抱环形部署模式的价值是什么？
- 将您当前的基础架构转换为环形部署模式的成本是多少？

## 用户类型

在所示的例子中，用户在生产环境中一般分为三个环:

- **金丝雀(Canaries)**，他们自愿测试出血性功能，只要它们可用。
- **早期使用者(Early Adopters)**，他们自愿预览版本，被认为比金丝雀位更完善。
- **消费产品的用户(Users)**，在通过金丝雀和早期采用者之后。

![](/img/phase-rollout-with-rings-rings.png)

> **备注**
>
> 衡量出你的价值链中哪些用户最适合每一个环，如沟通与反馈的几率、可能会出现的风险。环的目标人群的设定对于确保成功至关重要。


## 应用拓扑

接下来你需要将应用的拓扑结构映射到环形部署模型中。限制变化对终端用户的影响，并要持续提供价值。价值既包括交付给最终用户的价值，也包括转换你现有基础设施的价值（投资回报率）。

> **备注**
>
> 环形部署模式不是一蹴而就! 需要从小规模、原型开始，并不断比较影响、价值和成本。

以feature-flags.co在Azure DevOps的扩展插件的开发与部署为案例。

首先在应用层面，Azure DevOps扩展插件市场的技术架构清晰，易于消化、扩展和独立部署。每一个扩展插件的开发与集成都会包含如下几个模块:

- 拥有一个或多个网页和脚本文件
- 核心客户端的接口
- REST客户端和REST API的接口。
- 将状态保存在缓存或弹性存储中

![](/img/phase-rollout-with-rings-app-layer.png)

在基础设施层面，扩展发布到 Visual Studio 市场。一旦在被用户安装安装，它们就会被Azure DevOps服务门户托管，并将状态持久化到Azure存储和/或扩展数据存储。

![](/img/phase-rollout-with-rings-inf-layer.png)

扩展拓扑完全适合环形部署模式，并将扩展发布到每个部署环。

- 内部开发版发给金丝雀环中的用户(Canaries)
- 预览版发给早期养成用户环(Early Adopters)
- 最终版发给公共用户环(Users)

> 使用feature-flags.co来控制发布，您可以有效地限制和控制您明确邀请的用户的曝光率。


## 通过部署环进行变更

让我们观察一下变更是如何在基于环的部署过程中触发和移动的。

> 这里我们使用最新的Release概念，而不是传统的CI/CD。Release即将CI/CD合为一体。
> 这里使用Release概念的目的是为了让我们更简单的了解feature-flags对渐进式部署的作用方法。

![](/img/feature-flags-progressive-release.png)

我们还以feature-flags.co在Azure DevOps的扩展插件的开发与部署为案例:

1. feature-flags.co的贡献者提交了一个功能特性的代码。
2. 经过了开发、测试、预发布环境后，在人工或自动的校验后，出发持续部署触发器，自动启动Canaries环境部署。
3. 插件首先部署给“金丝雀”用户组，这是一个私人预订的用户组，即在marketplace上除了这部分用户组人群，其他的用户都看不到。
4. 此时“金丝雀”用户组拥有权限去验证次功能特性的可用性，一旦足够数量的用户组成员验证可用性后，将触发早起用户群的功能部署。
![](/img/phase-rollout-with-rings-users-approval.png)
6. 早期功能部署后，那么早期用户组的成员将会看到新的功能特性。
7. 当早起用户组的成员使用，并且我们通过监测系统发现符合上线给所有用户的条件时。则认为或通过预设条件自动触发所有用户组的新功能特性部署
![](/img/phase-rollout-with-rings-early-approval.png)

8. 用户部署向市场发布一个公共扩展。在这个阶段，每个在其组织中安装了扩展的人都会受到变化的影响。
9. 关键是要意识到，当你的变更在环中移动时，影响（"爆炸半径"）会增加。向金丝雀和早期使用者做公开变更，是给了两个机会来验证变更，并在发布到生产中之前对关键的错误进行热修复。

## 市场监测与反馈

您需要有效的监控和可操作的警报来检测和缓解问题。确定什么类型的数据是重要的，例如基础设施问题、违规行为和功能使用。专注于可操作的警报，以避免用户忽略它们并错过高优先级问题。

从数据的高级视图开始，您可以从远处观看可视化仪表板，并根据需要进行钻取。对你的视图进行定期的内务管理，去除所有的噪音。一个可视化的仪表盘讲述的故事远比数百封通知邮件要好得多，这些通知邮件经常被邮件规则过滤和遗忘。

在多个云平台中，你可以建立你的管道、前置和周期时间等信息的概述。在示例仪表板中，很明显，有34个成功的构建，21个成功的发布，1个失败的发布和2个正在进行的发布。

![](/img/phase-rollout-with-rings-dash.png)



## 有什么价值？

使用环形部署策略，你可以收集反馈来验证你的假设。你可以停用旧版本，并发布新版本，而不会有影响所有用户的风险。

以下是ALM | DevOps Ranger工程流程如何随着环形部署模型的发展而发展的总结。

| Before using Rings | Impacted area | With Rings |
|--|--|--| 
|Manual and error prone | 	Build | Automated and consistent
|Manual and error prone | 	Release | Automated and consistent
|Hours | Time to build (TTB) | Seconds
|Days | Time to release (TTR) | Minutes
|Call from user | Issue detection | Proactive
|Days to weeks | Issue resolution | Minutes to days

关键词:

- 一致和可靠的自动化
- 缩短反应时间
- 金丝雀体验到了痛苦，而不是用户

## 功能标志是否有依赖性？

不，环和特征标志是共生的。特征标志可以让你对包含在你的变更中的特征进行精细的控制。例如，如果你对某一特性没有十足的信心，你可以使用特性标志在一个或所有的部署环中隐藏该特性。例如，你可以启用金丝雀环中的所有功能，并为早期采用者和生产用户微调一个子集，如图所示。请参阅[功能标志或环了解更多信息](https://opensource.com/article/18/2/feature-flags-ring-deployment-model)。


![](/img/phase-rollout-with-rings-feature-flags.png)

## 总结

现在你已经涵盖了环的概念，你应该有信心去探索改进CI/CD管道的方法。虽然环的使用增加了复杂程度，但有一个游戏计划来解决功能管理和快速客户反馈是非常宝贵的。 -->
